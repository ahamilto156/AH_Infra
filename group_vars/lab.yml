---
# MOTD vars
sys_env: LAB

# InfluxDB
influxdb_admin_user: admin
influxdb_admin_password: "{{ vault_influxdb_admin_password }}"
influxdb_databases:
  - host: "{{ ansible_fqdn }}"
    name: 'prometheus'
    state: present
    retention_policy:
      enabled: true
      name: test-1w
      duration: 1w
      replication: 1
  - host: "{{ ansible_fqdn }}"
    name: 'openhab'
    state: present
    retention_policy:
      enabled: true
      name: test-1w
      duration: 1w
      replication: 1

influxdb_users:
  - username: 'prometheus'
    password: "{{ vault_influxdb_prometheus_password }}"
    permissions:
    - database: 'prometheus'
      grants: ALL
  - username: 'grafana_prometheus'
    password: "{{ vault_influxdb_grafana_password }}"
    permissions:
    - database: 'prometheus'
      grants: READ
  - username: 'openhab'
    password: "{{ vault_influxdb_openhab_password }}"
    permissions:
    - database: 'openhab'
      grants: ALL
  - username: 'grafana_openhab'
    password: "{{ vault_influxdb_grafana_password }}"
    permissions:
    - database: 'openhab'
      grants: READ



# Prometheus parameters
prometheus_external_labels:
  environment: "LAB"

prometheus_targets:
  node:
  - targets:
    - "{{ ansible_fqdn }}:9100"
    labels:
      env: LAB

prometheus_static_targets_files:
  - prometheus/targets/lab.json


# Figure out how to dynamically update the target.json list.....
prometheus_scrape_configs:
  - job_name: "prometheus"
    metrics_path: "{{ prometheus_metrics_path }}"
    static_configs:
      - targets:
          - "{{ ansible_fqdn | default(ansible_host) | default('localhost') }}:9090"
  - job_name: "node"
    file_sd_configs:
      - files:
          - "{{ prometheus_config_dir }}/file_sd/node.yml"
          - "{{ prometheus_config_dir }}/file_sd/lab.json"


# Enable and configure LDAP
grafana_auth:
  disable_login_form: false
  oauth_auto_login: false
  disable_signout_menu: false
  signout_redirect_url: ""
  anonymous:
    org_name: "Main Organization"
    org_role: Viewer
  ldap:
    config_file: "/etc/grafana/ldap.toml"
    allow_sign_up: false
  basic:
    enabled: true

grafana_ldap:
  verbose_logging: false
  servers:
    host: "{{ ldap_servers[0] }}"
    port: 389 # 636 for SSL
    use_ssl: false
    start_tls: true
    ssl_skip_verify: true
    root_ca_cert: "{{ tls_cafile }}"
    bind_dn: "uid=svc-grafana,cn=users,cn=accounts,dc=gatwards,dc=org"
    bind_password: grafana
    search_filter: "{{ ldap_user_filter }}"
    search_base_dns:
      - "{{ ldap_user_base }}"
    group_search_filter: "{{ ldap_group_filter }}"
    group_search_base_dns:
      - "{{ ldap_group_base }}"
    attributes:
      name: givenName
      surname: sn
      username: uid  # sAMAccountName  on AD
      member_of: memberOf
      email: mail
  group_mappings:
    - name: Main Org.
      id: 1
      groups:
        - group_dn: "cn=grafana-admins,cn=groups,cn=accounts,dc=grafana,dc=org"
          org_role: Admin
        - group_dn: "cn=grafana-editors,cn=groups,cn=accounts,dc=grafana,dc=org"
          org_role: Editor
        - group_dn: "*"
          org_role: Viewer
