
yum -y update
yum -y install python-devel libffi-devel gcc openssl-devel libselinux-python
yum -y install epel-release
yum -y install python2-pip
yum -y install python-virtualenv ansible

virtualenv /root/openstack
source /root/openstack/bin/activate
pip install -U pip
pip install ansible
pip install kolla-ansible

mkdir -p /etc/kolla
chown $USER:$USER /etc/kolla
cp -r /root/openstack/share/kolla-ansible/etc_examples/kolla/* /etc/kolla
cp /root/openstack/share/kolla-ansible/ansible/inventory/* .
kolla-genpwd

sed -i 's/^#pipelining.*/pipelining = True/' /etc/ansible/ansible.cfg
sed -i 's/^#forks.*/forks          = 100/' /etc/ansible/ansible.cfg
sed -i 's/^#host_key_checking.*/host_key_checking = False/' /etc/ansible/ansible.cfg



sed -i 's/^#kolla_base_distro:.*/kolla_base_distro: "centos"/' /etc/kolla/globals.yml
sed -i 's/^#kolla_install_type:.*/kolla_install_type: "binary"/' /etc/kolla/globals.yml
sed -i 's/^#openstack_release:.*/openstack_release: "train"/' /etc/kolla/globals.yml
sed -i 's/^#om_rpc_transport:.*/om_rpc_transport: "rabbit"/' /etc/kolla/globals.yml
sed -i 's/^#kolla_internal_vip_address:.*/kolla_internal_vip_address: "172.22.4.201"/' /etc/kolla/globals.yml
# sed -i 's/^#kolla_external_vip_address:.*/kolla_external_vip_address: "172.22.6.201"/' /etc/kolla/globals.yml
# sed -i 's/^#kolla_external_fqdn:.*/kolla_external_fqdn: "stack.lab.home.gatwards.org"/' /etc/kolla/globals.yml
# sed -i 's/^#kolla_external_vip_interface:.*/kolla_external_vip_interface: "eno2"/' /etc/kolla/globals.yml
sed -i 's/^#kolla_internal_fqdn:.*/kolla_internal_fqdn: "stack.lab.home.gatwards.org"/' /etc/kolla/globals.yml
sed -i 's/^#network_interface:.*/network_interface: "eno1"/' /etc/kolla/globals.yml
sed -i 's/^#neutron_external_interface:.*/neutron_external_interface: "ens5f0"/' /etc/kolla/globals.yml
sed -i 's/^#enable_openstack_core:.*/enable_openstack_core: "yes"/' /etc/kolla/globals.yml
sed -i 's/^#enable_central_logging:.*/enable_central_logging: "yes"/' /etc/kolla/globals.yml
sed -i 's/^#enable_grafana:.*/enable_grafana: "yes"/' /etc/kolla/globals.yml
sed -i 's/^#enable_prometheus:.*/enable_prometheus: "yes"/' /etc/kolla/globals.yml
sed -i 's/^#enable_telegraf:.*/enable_telegraf: "yes"/' /etc/kolla/globals.yml


kolla-ansible -i ./all-in-one bootstrap-servers
kolla-ansible -i ./all-in-one prechecks
kolla-ansible -i ./all-in-one deploy

pip install python-openstackclient
kolla-ansible post-deploy
. /etc/kolla/admin-openrc.sh
